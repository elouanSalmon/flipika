rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // FONCTIONS HELPER DE VALIDATION
    // ========================================
    
    // Vérifie qu'une chaîne est valide et dans les limites
    function isValidString(str, minLen, maxLen) {
      return str is string 
        && str.size() >= minLen 
        && str.size() <= maxLen;
    }
    
    // Vérifie qu'un timestamp est récent (moins de 5 minutes)
    function isRecentTimestamp(ts) {
      return ts is timestamp 
        && ts > request.time - duration.value(5, 'm');
    }
    
    // Vérifie que l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifie que l'utilisateur est propriétaire
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // RÈGLES PAR DÉFAUT : DENY ALL
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ========================================
    // TOKENS GOOGLE ADS (Refresh Tokens)
    // ========================================
    match /users/{userId}/tokens/{tokenId} {
      // Lecture : uniquement le propriétaire
      allow read: if isOwner(userId);
      
      // Écriture : uniquement le propriétaire + validation du schéma
      allow write: if isOwner(userId) 
        && request.resource.data.keys().hasAll(['refresh_token', 'scopes', 'created_at', 'updated_at'])
        && isValidString(request.resource.data.refresh_token, 10, 500)
        && request.resource.data.scopes is list
        && request.resource.data.scopes.size() <= 10
        && request.resource.data.created_at is timestamp
        && request.resource.data.updated_at is timestamp;
    }
    
    // ========================================
    // OAUTH STATES (Protection CSRF)
    // ========================================
    match /oauth_states/{stateId} {
      // Création : utilisateur authentifié + validation
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userId', 'createdAt', 'expiresAt'])
        && request.resource.data.userId == request.auth.uid
        && isValidString(stateId, 20, 50) // État aléatoire sécurisé
        && request.resource.data.createdAt is timestamp
        && request.resource.data.expiresAt is timestamp
        && request.resource.data.expiresAt > request.time; // Expiration future
      
      // Suppression : uniquement le propriétaire OU expiration automatique
      allow delete: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid 
            || resource.data.expiresAt < request.time);
      
      // Pas de lecture pour renforcer la sécurité CSRF
      allow read: if false;
    }
    
    // ========================================
    // PROFILS UTILISATEURS
    // ========================================
    match /users/{userId} {
      // Allow public read access for user profiles (needed for public reports)
      // This allows displaying author information on public reports
      allow read: if true;
      
      allow create: if isOwner(userId)
        && request.resource.data.email is string
        && request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
        && request.resource.data.username is string
        && request.resource.data.username.size() >= 3
        && request.resource.data.username.size() <= 30
        && request.resource.data.username.matches('^[a-z0-9_-]+$')
        && request.resource.data.firstName is string
        && request.resource.data.firstName.size() >= 1
        && request.resource.data.firstName.size() <= 50
        && request.resource.data.lastName is string
        && request.resource.data.lastName.size() >= 1
        && request.resource.data.lastName.size() <= 50
        && (!('company' in request.resource.data) || (request.resource.data.company is string && request.resource.data.company.size() <= 100))
        && (!('description' in request.resource.data) || (request.resource.data.description is string && request.resource.data.description.size() <= 500))
        && request.resource.data.hasCompletedOnboarding is bool
        && (!('hasCompletedTutorial' in request.resource.data) || request.resource.data.hasCompletedTutorial is bool);
      
      allow update: if isOwner(userId)
        && (!('username' in request.resource.data) || (
          request.resource.data.username is string
          && request.resource.data.username.size() >= 3
          && request.resource.data.username.size() <= 30
          && request.resource.data.username.matches('^[a-z0-9_-]+$')
        ))
        && (!('firstName' in request.resource.data) || (
          request.resource.data.firstName is string
          && request.resource.data.firstName.size() >= 1
          && request.resource.data.firstName.size() <= 50
        ))
        && (!('lastName' in request.resource.data) || (
          request.resource.data.lastName is string
          && request.resource.data.lastName.size() >= 1
          && request.resource.data.lastName.size() <= 50
        ))
        && (!('company' in request.resource.data) || (request.resource.data.company is string && request.resource.data.company.size() <= 100))
        && (!('description' in request.resource.data) || (request.resource.data.description is string && request.resource.data.description.size() <= 500));
      
      allow delete: if isOwner(userId);
    }
    
    // ========================================
    // USER INTEGRATIONS (Google Ads, etc.)
    // ========================================
    match /users/{userId}/integrations/{integrationId} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // CLIENTS MANAGEMENT
    // ========================================
    match /users/{userId}/clients/{clientId} {
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // GOOGLE ADS ACCOUNTS
    // ========================================
    match /googleAdsAccounts/{accountId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // REPORT THEMES
    // ========================================
    match /report_themes/{themeId} {
      // Users can read their own themes (individual document)
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Users can query/list their own themes
      allow list: if request.auth != null 
        && request.query.limit <= 100
        && resource.data.userId == request.auth.uid;
      
      // Users can create themes with their own userId
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Users can update and delete their own themes
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // USERNAMES (Uniqueness tracking)
    // ========================================
    match /usernames/{username} {
      // Allow public read for username lookups (needed for public reports)
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // ========================================
    // DONNÉES GOOGLE ADS (Campagnes, Métriques)
    // ========================================
    match /users/{userId}/campaigns/{campaignId} {
      allow read: if isOwner(userId);
      
      // Écriture uniquement via Cloud Functions (pas directement depuis le client)
      // Écriture uniquement via Cloud Functions (pas directement depuis le client)
      allow write: if false;
    }
    
    match /users/{userId}/google_ads_accounts/{accountId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    match /users/{userId}/reports/{reportId} {
      allow read: if isOwner(userId);
      
      allow create, update: if isOwner(userId)
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 1
        && request.resource.data.title.size() <= 200
        && (!('isPublic' in request.resource.data) || request.resource.data.isPublic is bool);
      
      allow delete: if isOwner(userId);
    }
    
    // ========================================
    // PUBLIC REPORTS (Shareable via username)
    // ========================================
    match /public_reports/{username}/{reportId} {
      // Anyone can read public reports
      allow read: if true;
      
      // Only the owner can write
      allow write: if isAuthenticated() 
        && exists(/databases/$(database)/documents/usernames/$(username))
        && get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
    }
    
    // ========================================
    // REPORTS (New CRUD System)
    // ========================================
    match /reports/{reportId} {
      // Read: owner, or anyone if published
      allow read: if (isAuthenticated() && request.auth.uid == resource.data.userId) 
        || resource.data.status == 'published';
      
      // Create: authenticated user with valid data
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 1
        && request.resource.data.title.size() <= 200
        && request.resource.data.status in ['draft', 'published', 'archived']
        && request.resource.data.sections is list
        && request.resource.data.widgetIds is list
        && request.resource.data.campaignIds is list;
      
      // Update: only owner
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId; // Prevent userId change
      
      // Delete: only owner
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
      
      // Widgets sub-collection
      match /widgets/{widgetId} {
        // Read: if user owns the parent report OR if parent report is published
        allow read: if (isAuthenticated() 
          && exists(/databases/$(database)/documents/reports/$(reportId))
          && get(/databases/$(database)/documents/reports/$(reportId)).data.userId == request.auth.uid)
          || (exists(/databases/$(database)/documents/reports/$(reportId))
          && get(/databases/$(database)/documents/reports/$(reportId)).data.status == 'published');
        
        // Write: only if user owns the parent report
        allow write: if isAuthenticated() 
          && exists(/databases/$(database)/documents/reports/$(reportId))
          && get(/databases/$(database)/documents/reports/$(reportId)).data.userId == request.auth.uid;
      }
    }
    
    // ========================================
    // WIDGET INSTANCES (Cached widget data)
    // ========================================
    match /widgetInstances/{instanceId} {
      // Read: anyone (needed for public report viewing with cached data)
      // The data is not sensitive - it's just cached Google Ads metrics
      allow read: if true;
      
      // Create/Update: authenticated users only (to cache their widget data)
      allow create, update: if isAuthenticated()
        && request.resource.data.widgetConfigId is string
        && request.resource.data.reportId is string
        && request.resource.data.data != null;
      
      // Delete: only the report owner
      allow delete: if isAuthenticated()
        && exists(/databases/$(database)/documents/reports/$(resource.data.reportId))
        && get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.userId == request.auth.uid;
    }
    
    // ========================================
    // WIDGET TEMPLATES (Reusable configurations)
    // ========================================
    match /widgetTemplates/{templateId} {
      // Read: owner or default templates
      allow read: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || resource.data.isDefault == true);
      
      // Create: authenticated user
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.name.size() >= 1
        && request.resource.data.name.size() <= 100
        && request.resource.data.type in ['performance_overview', 'campaign_chart'];
      
      // Update/Delete: only owner
      allow update, delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
    }
    
    // ========================================
    // REPORT TEMPLATES (Reusable report configurations)
    // ========================================
    match /reportTemplates/{templateId} {
      // Read: only owner
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // List: users can query their own templates
      allow list: if isAuthenticated()
        && request.query.limit <= 100
        && resource.data.userId == request.auth.uid;
      
      // Create: authenticated user with valid data
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.name.size() >= 1
        && request.resource.data.name.size() <= 100
        && request.resource.data.periodPreset in ['last_7_days', 'last_30_days', 'last_90_days', 'this_month', 'last_month', 'this_quarter', 'last_quarter', 'this_year', 'last_year']
        && request.resource.data.widgetConfigs is list
        && request.resource.data.campaignIds is list;
      
      // Update: only owner
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId;
      
      // Delete: only owner
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }

    // ========================================
    // SCHEDULED REPORTS (Automated report generation)
    // ========================================
    match /scheduledReports/{scheduleId} {
      // Read: only owner
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // List: users can query their own schedules
      allow list: if isAuthenticated()
        && request.query.limit <= 100
        && resource.data.userId == request.auth.uid;
      
      // Create: authenticated user with valid data
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.name.size() >= 1
        && request.resource.data.name.size() <= 100
        && request.resource.data.templateId is string
        && request.resource.data.accountId is string
        && request.resource.data.scheduleConfig.frequency in ['daily', 'weekly', 'monthly', 'custom']
        && request.resource.data.isActive is bool;
      
      // Update: only owner
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId;
      
      // Delete: only owner
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.userId;
    }

    
    // ========================================
    // STRIPE SUBSCRIPTIONS
    // ========================================
    match /subscriptions/{userId} {
      // Read: only the owner can read their subscription
      allow read: if isOwner(userId);
      
      // Write: only Cloud Functions can write subscription data
      // This prevents users from tampering with their subscription status
      allow write: if false;
    }
    
    // ========================================
    // BILLING HISTORY
    // ========================================
    match /billingHistory/{eventId} {
      // Read: users can read their own billing history
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // List: users can query their own billing history
      allow list: if isAuthenticated()
        && request.query.limit <= 100
        && resource.data.userId == request.auth.uid;
      
      // Write: only Cloud Functions can write billing events
      allow write: if false;
    }
    
    // ========================================
    // RATE LIMITS (pour Cloud Functions)
    // ========================================
    match /rate_limits/{limitId} {
      // Seulement accessible par les Cloud Functions
      allow read, write: if false;
    }
  }
}